<div class="wrapper">
    <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="settings"/>
    <div>
        <input class="show-pilot" name="attr_isPilot" type="checkbox" checked hidden/>
        <button type="action" name="act_pilot" class="tabs pilot-button">Pilot</button>

        <input class="show-mech" name="attr_isMech" type="checkbox" hidden/>
        <button type="action" name="act_mech" class="tabs mech-button">Mech</button>

        <input class="show-crawler" name="attr_isCrawler" type="checkbox" hidden/>
        <button type="action" name="act_crawler" class="tabs crawler-button">Union Crawler</button>

        <button type="action" name="act_settings" class="tabs">Settings</button>
    </div>

    <div class="pilot">
        <h2>Pilot
            <button type="roll" value="&{template:roll}{{name=@{character_name}}}{{roll=[[1d20]]}}"></button>
        </h2>
        <div style="display:flex">
            <div class="twocolumns">
                <div class="descValuePair">
                    <label for="name">Callsign</label>
                    <input id="name" type="text" class="checkboxSpacer" name="attr_character_name">
                </div>
                <div class="descValuePair">
                    <label for="class">Class</label>
                    <input id="class" type="text" class="checkboxSpacer" name="attr_character_class">
                </div>
                <details>
                    <summary>
                            <span class="descValuePair">
                                <label>Background</label>
                                <input type="text" name="attr_background">
                                <input type="checkbox" name="attr_backgroundUsed">
                            </span>
                    </summary>
                    <textarea name="attr_backgroundDetails"></textarea>
                </details>
                <details>
                    <summary>
                            <span class="descValuePair">
                                <label>Keepsake </label>
                                <input type="text" name="attr_keepsake">
                                <input type="checkbox" name="attr_keepsakeUsed">
                            </span>
                    </summary>
                    <textarea name="attr_keepsakeDetails"></textarea>
                </details>
                <details>
                    <summary>
                            <span class="descValuePair">
                                <label>Motto </label>
                                <input type="text" name="attr_motto">
                                <input type="checkbox" name="attr_mottoUsed">
                            </span>
                    </summary>
                    <textarea name="attr_mottoDetails"></textarea>
                </details>
            </div>

            <div class="marginleft twocolumns">
                <div class="descValuePair">
                    <label for="health">Health</label>
                    <input id="health" type="number" min="0" name="attr_health" value="10">
                    <label> of <input type="number" min="0" name="attr_health_max" value="10"></label>
                </div>
                <div class="descValuePair">
                    <label for="abilityPts">Ability Pts </label>
                    <input id="abilityPts" type="number" min="0" name="attr_abilitypts" value="5">
                    <label> of <input type="number" min="5" name="attr_abilitypts_max" value="5"></label>
                </div>
            </div>
        </div>

        <h3>Weapons</h3>
        <div class="weapon">
            <label>Name</label>
            <label>Range</label>
            <label>Damage</label>
        </div>
        <div>
            <fieldset class="repeating_weapons">
                <details>
                    <summary>
                        <input type="text" name="attr_weaponname" title="Name of the Weapon">
                        <input type="text" name="attr_range" title="Range">
                        <input type="text" name="attr_damage" title="Damage">
                        <button type="roll" title="Fire the Weapon" value="&{template:weapon}{{callsign=@{character_name}}}{{range=@{range}}}{{weapon_name=@{weaponname}}}{{roll=[[1d20]]}}{{damage=@{damage}}}">
                        </button>
                    </summary>
                    <textarea name="attr_weaponDetails"></textarea>
                </details>
            </fieldset>
        </div>

        <h3>Inventory</h3>
        <div class="inventory">
            <details>
                <summary>
                    <input type="text" name="attr_itemname1">
                </summary>
                <textarea name="attr_itemDetails1"></textarea>
            </details>
            <details>
                <summary>
                    <input type="text" name="attr_itemname2">
                </summary>
                <textarea name="attr_itemDetails2"></textarea>
            </details>
            <details>
                <summary>
                    <input type="text" name="attr_itemname3">
                </summary>
                <textarea name="attr_itemDetails3"></textarea>
            </details>
            <details>
                <summary>
                    <input type="text" name="attr_itemname4">
                </summary>
                <textarea name="attr_itemDetails4"></textarea>
            </details>
            <details>
                <summary>
                    <input type="text" name="attr_itemname5">
                </summary>
                <textarea name="attr_itemDetails5"></textarea>
            </details>
            <details>
                <summary>
                    <input type="text" name="attr_itemname6">
                </summary>
                <textarea name="attr_itemDetails6"></textarea>
            </details>
        </div>

        <h3>Equipment</h3>
        <div class="equipment">
            <label>Name</label>
            <label>AP/Uses</label>
            <label>Range</label>
            <label>Action</label>
        </div>
        <fieldset class="repeating_equipment">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Equipment">
                    <input type="text" name="attr_cost" title="AP/Uses">
                    <input type="text" name="attr_range" title="Range">
                    <input type="text" name="attr_action" title="Action">
                </summary>
                <textarea name="attr_equipment" class="textarea"></textarea>
            </details>
        </fieldset>

        <h3>Abilities</h3>
        <div class="equipment">
            <label>Name</label>
            <label>AP</label>
            <label>Range</label>
            <label>Action</label>
        </div>
        <fieldset class="repeating_abilities">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Ability">
                    <input type="text" name="attr_cost" title="AP">
                    <input type="text" name="attr_range" title="Range">
                    <input type="text" name="attr_action" title="Action">
                </summary>
                <textarea name="attr_ability" class="textarea"></textarea>
            </details>
        </fieldset>
    </div>

    <div class="mech">
        <h2>Mech
            <button type="roll" value="&{template:roll}{{name=@{character_name}}}{{roll=[[1d20]]}}{{mech=1}}"></button>
        </h2>
        <div style="display:flex">
            <div class="twocolumns">
                <div class="descValuePair">
                    <label for="mechname">Name</label>
                    <input id="mechname" type="text" name="attr_character_name">
                </div>
                <div class="descValuePair">
                    <label for="system">System Slots</label>
                    <input id="system" type="text" name="attr_system">
                </div>
                <div class="descValuePair">
                    <label for="module">Module Slots </label>
                    <input id="module" type="text" name="attr_module">
                </div>
                <details>
                    <summary>
                            <span class="descValuePair">
                                <label for="chassis">Chassis Type </label>
                                <input id="chassis" type="text" name="attr_chassis">
                            </span>
                    </summary>
                    <textarea name="attr_chassisDetails"></textarea>
                </details>
            </div>

            <div class="marginleft twocolumns">
                <div class="descValuePair">
                    <label for="structure">Structure</label>
                    <input type="number" id="structure" min="0" name="attr_structure" value="10">
                    <label> of <input type="number" min="0" name="attr_structure_max" value="10"></label>
                </div>
                <div class="descValuePair">
                    <label for="energyPts">Energy Pts </label>
                    <input type="number" id="energyPts" min="0" name="attr_energy" value="10">
                    <label> of <input type="number" min="0" name="attr_energy_max" value="10"></label>
                </div>
                <div class="descValuePair">
                    <button type="action" class="textbutton" name="act_reactOverload">Heat</button>
                    <input type="number" min="0" max="10" name="attr_heat" value="0">
                    <label> of <input type="number" min="0" name="attr_heat_max" value="10"> </label>
                </div>
            </div>
        </div>

        <h3>Weapons</h3>
        <div class="weapon">
            <label>Name</label>
            <label>Range</label>
            <label>Damage</label>
        </div>
        <div>
            <fieldset class="repeating_mechweapons">
                <details>
                    <summary>
                        <input type="text" name="attr_weaponname" title="Name of the Weapon">
                        <input type="text" name="attr_range" title="Range">
                        <input type="text" name="attr_damage" title="Damage">
                        <button type="roll" title="Fire the Weapon" value="&{template:weapon}{{callsign=@{character_name}}}{{range=@{range}}}{{weapon_name=@{weaponname}}}{{roll=[[1d20]]}}{{damage=@{damage}}}{{mech=1}}">
                        </button>
                    </summary>
                    <details class="subdetails">
                        <summary>
                            Settings
                        </summary>
                        <div class="descValuePair">
                            <label>Heat produced</label>
                            <input type="text" name="heat" placeholder="1">
                        </div>
                        <div class="descValuePair">
                            <label>Cost</label>
                            <input type="text" name="cost" placeholder="1 T1 Scrap">
                        </div>
                        <div class="descValuePair">
                            <label>Slots</label>
                            <input type="text" name="slot" placeholder="1 System">
                        </div>
                    </details>
                    <textarea name="attr_weaponDetails"></textarea>
                </details>
            </fieldset>
        </div>

        <h3>Cargo <input type="text" name="attr_maxcargo" title="Maximum cargo capacity" style="max-width: 30px;"></h3>
        <fieldset class="repeating_cargo">
            <details>
                <summary>
                    <input type="text" name="attr_cargoname">
                </summary>
                <textarea class="textarea" name="attr_cargo"></textarea>
            </details>

        </fieldset>

        <h3>Modules</h3>
        <div class="equipment">
            <label>Name</label>
            <label>EP/Uses</label>
            <label>Range</label>
            <label>Action</label>
        </div>
        <fieldset class="repeating_modules">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Equipment">
                    <input type="text" name="attr_cost" title="AP/Uses">
                    <input type="text" name="attr_range" title="Range">
                    <input type="text" name="attr_action" title="Action">
                </summary>
                <textarea name="attr_details" class="textarea"></textarea>
                <div class="descValuePair">
                    <label>Cost</label>
                    <input type="text" name="cost" placeholder="1 T1 Scrap">
                </div>
                <div class="descValuePair">
                    <label>Slots</label>
                    <input type="text" name="slot" placeholder="1 System">
                </div>
            </details>
        </fieldset>

        <h3>Systems</h3>
        <div class="equipment">
            <label>Name</label>
            <label>EP/Uses</label>
            <label>Range</label>
            <label>Action</label>
        </div>
        <fieldset class="repeating_systems">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Equipment">
                    <input type="text" name="attr_cost" title="AP/Uses">
                    <input type="text" name="attr_range" title="Range">
                    <input type="text" name="attr_action" title="Action">
                </summary>
                <textarea name="attr_details" class="textarea"></textarea>
                <div class="descValuePair">
                    <label>Cost</label>
                    <input type="text" name="cost" placeholder="1 T1 Scrap">
                </div>
                <div class="descValuePair">
                    <label>Slots</label>
                    <input type="text" name="slot" placeholder="1 System">
                </div>
            </details>
        </fieldset>
    </div>

    <div class="crawler">
        <h2>Crawler
            <button type="roll" value="&{template:roll}{{name=@{character_name}}}{{roll=[[1d20]]}}"></button>
        </h2>
        <div style="display:flex">
            <div class="twocolumns">
                <div class="descValuePair">
                    <label for="crawlername">Name</label>
                    <input id="crawlername" type="text" name="attr_character_name">
                </div>
                <details>
                    <summary>
                            <span class="descValuePair">
                                <label for="type">Crawler Type</label>
                                <input id="type" type="text" name="attr_crawlertype">
                            </span>
                    </summary>
                    <textarea name="attr_typeDetails"></textarea>
                </details>
                <div class="descValuePair">
                    <label for="techlevel">Tech Level</label>
                    <input id="techlevel" type="text" name="attr_techlevel">
                </div>
                <div class="descValuePair">
                    <label for="upgrade">Upgrade</label>
                    <input id="upgrade" type="text" name="attr_upgrade">
                </div>
            </div>

            <div class="marginleft twocolumns">
                <div class="descValuePair">
                    <label for="crawlerstructure">Structure</label>
                    <input type="number" id="crawlerstructure" min="0" name="attr_structure" value="20">
                    <label> of <input type="number" min="0" name="attr_structure_max" value="20"></label>
                </div>
            </div>
        </div>

        <h3>Weapons</h3>
        <div class="weapon">
            <label>Name</label>
            <label>Range</label>
            <label>Damage</label>
        </div>
        <div>
            <fieldset class="repeating_mechweapons">
                <details>
                    <summary>
                        <input type="text" name="attr_weaponname" title="Name of the Weapon">
                        <input type="text" name="attr_range" title="Range">
                        <input type="text" name="attr_damage" title="Damage">
                        <button type="roll" title="Fire the Weapon" value="&{template:weapon}{{callsign=@{character_name}}}{{range=@{range}}}{{weapon_name=@{weaponname}}}{{roll=[[1d20]]}}{{damage=@{damage}}}{{mech=1}}">
                        </button>
                    </summary>
                    <details class="subdetails">
                        <summary>
                            Settings
                        </summary>
                        <div class="descValuePair">
                            <label>Heat produced</label>
                            <input type="text" name="heat" placeholder="1">
                        </div>
                        <div class="descValuePair">
                            <label>Cost</label>
                            <input type="text" name="cost" placeholder="1 T1 Scrap">
                        </div>
                        <div class="descValuePair">
                            <label>Slots</label>
                            <input type="text" name="slot" placeholder="1 System">
                        </div>
                    </details>
                    <textarea name="attr_weaponDetails"></textarea>
                </details>
            </fieldset>
        </div>

        <h3>Crew</h3>
        <div class="equipment">
            <label>Name</label>
            <label>Role</label>
        </div>
        <fieldset class="repeating_crew">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Crew">
                    <input type="text" name="attr_role" title="Role of the Crew">
                </summary>
                <textarea name="attr_details" class="textarea"></textarea>
            </details>
        </fieldset>

        <h3>Cargo</h3>
        <fieldset class="repeating_cargo">
            <textarea name="attr_cargo" class="textarea"></textarea>
        </fieldset>

        <h3>Bays</h3>
        <fieldset class="repeating_bays">
            <details class="equipment">
                <summary>
                    <input type="text" name="attr_name" title="Name of the Bay">
                </summary>
                <textarea name="attr_details" class="textarea"></textarea>
            </details>
        </fieldset>
    </div>

    <div class="settings">
        <br>
        <label for="isPilot" class="settings-checkbox">
            <span>Is Pilot</span>
            <input id="isPilot" name="attr_isPilot" type="checkbox" checked/>
        </label>
        <br>
        <label for="isMech" class="settings-checkbox">
            <span>Is Mech</span>
            <input id="isMech" name="attr_isMech" type="checkbox"/>
        </label>
        <br>
        <label for="isCrawler" class="settings-checkbox">
            <span>Is Crawler</span>
            <input id="isCrawler" name="attr_isCrawler" type="checkbox"/>
        </label>
    </div>
</div>

<!--     Buttons used for reaction rolls-->
<div class="hidden-section" style="display:none">
    <button type="action" name="act_reactPush"></button>
    <button type="action" name="act_reactPushWeapon"></button>
    <button type="action" name="act_reactOverload"></button>
</div>


<script type="text/worker">
    const buttonlist = ["pilot","mech","crawler","settings"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

on('clicked:reactPush', async (ev) => {
    await push(ev, 'roll');
});

on('clicked:reactPushWeapon', async (ev) => {
    await push(ev, 'weapon');
});

const push = async (ev, template) => {

    let attrs = await asw.getAttrs(['character_name', 'heat']);

    let resultingHeat = parseInt(attrs.heat) + 2;

    let rollBase = `&{template:${template}}{{name=${attrs.character_name}}}{{roll=[[1d20]]}}{{mech=1}}{{heatroll=[[1d20]]}}{{heat=[[${resultingHeat}]]}}`;
    let roll = await startRoll(rollBase);

    asw.setAttrs({
		heat: resultingHeat
	});

    finishRoll(roll.rollId, {

    });
}

on('clicked:reactOverload', async (ev) => {
    await reactOverload(ev);
});

const reactOverload = async (ev) => {

    let attrs = await asw.getAttrs(['character_name', 'heat', 'heat_max']);

    let rollBase = `&{template:overload}{{name=${attrs.character_name}}}{{roll=[[1d20]]}}{{heat=${attrs.heat}}}{{maxheat=${attrs.heat_max}}}`;
    let roll = await startRoll(rollBase);

    finishRoll(roll.rollId, {

    });
}



const asw = (() => {
    const setActiveCharacterId = function(charId){
        let oldAcid=getActiveCharacterId();
        let ev = new CustomEvent("message");
        ev.data={"id":"0", "type":"setActiveCharacter", "data":charId};
        self.dispatchEvent(ev);
        return oldAcid;
    };
    const promisifyWorker = (worker, parameters) => {
        let acid=getActiveCharacterId();
        let prevAcid=null;
        return new Promise((res,rej)=>{
            prevAcid=setActiveCharacterId(acid);
            try {if (worker===0) getAttrs(parameters[0]||[],(v)=>res(v));
                else if (worker===1) setAttrs(parameters[0]||{}, parameters[1]||{},(v)=>res(v));
                else if (worker===2) getSectionIDs(parameters[0]||'',(v)=>res(v));
            } catch(err) {rej(console.error(err))}
        }).finally(()=>setActiveCharacterId(prevAcid));
    }
    return {
        getAttrs(attrArray) {return promisifyWorker(0, [attrArray])},
        setAttrs(attrObj, options) {return promisifyWorker(1, [attrObj, options])},
        getSectionIDs(section) {return promisifyWorker(2, [section])},
        setActiveCharacterId,
    }
})();
</script>

<rolltemplate class="sheet-rolltemplate-weapon">
    <table>
        <tr>
            <th>
                {{callsign}} rolls an attack on range {{range}} with {{weapon_name}}
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollBetween() roll 20 20}}
                <strong>Nailed it</strong> ({{roll}}) <br>
                You have overcome the odds and managed an outstanding success. You may achieve an additional bonus of your choice to the action e.g. double the damage.
                {{/rollBetween() roll 20 20}}

                {{#rollBetween() roll 11 19}}
                Success ({{roll}}) - You hit the target and deal standard damage
                {{/rollBetween() roll 11 19}}

                {{#rollBetween() roll 6 10}}
                Tough Choice ({{roll}}) - You succeed in your action but at a cost. The Mediator will give you a tough choice with some kind of consequence. You hit but something has
                gone wrong.
                {{/rollBetween() roll 6 10}}

                {{#rollBetween() roll 2 5}}
                Failure ({{roll}}) - You miss the target.
                {{/rollBetween() roll 2 5}}

                {{#rollBetween() roll 1 1}}
                Cascade Failure ({{roll}}) - You miss the target and something has gone wrong.
                {{/rollBetween() roll 1 1}}
            </td>
        </tr>
        {{#damage}}
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                Weapondamage: {{damage}}
            </td>
        </tr>
        {{/damage}}
        {{#heat}}
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                Heat Check: {{heat}} vs {{heatroll}}
            </td>
        </tr>
        {{/heat}}
    </table>
    {{#mech}}
    <div class="sheet-rolltemplate-button-row">
        <div class="sheet-rolltemplate-button">
            [Push](~{{callsign}}|reactPushWeapon)
        </div>

        {{#^rollGreater() heatroll heat}}
        <div class="sheet-rolltemplate-button">
            [Reactor Overload](~{{callsign}}|reactOverload)
        </div>
        {{/^rollGreater() heatroll heat}}
    </div>
    {{/mech}}
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-roll">
    <table>
        <tr>
            <th>
                {{name}} rolls
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollBetween() roll 20 20}}
                <strong>Nailed it</strong> ({{roll}}) <br>
                You have overcome the odds and managed an outstanding success. You may achieve an additional bonus of your choice to the action. When dealing damage you double it.
                {{/rollBetween() roll 20 20}}

                {{#rollBetween() roll 11 19}}
                Success ({{roll}}) - You’ve achieved your goal without any compromises.
                {{/rollBetween() roll 11 19}}

                {{#rollBetween() roll 6 10}}
                Tough Choice ({{roll}}) - You succeed in your action but at a cost. The Mediator will give you a tough choice with some kind of consequence.
                {{/rollBetween() roll 6 10}}

                {{#rollBetween() roll 2 5}}
                Failure ({{roll}}) - You’ve failed at what you were attempting, and you’ll face a consequence of The Mediator’s choice.
                {{/rollBetween() roll 2 5}}

                {{#rollBetween() roll 1 1}}
                Cascade Failure ({{roll}}) - You have not only failed, but something has gone terribly wrong. You will suffer a severe consequence of The Mediator’s choice.
                {{/rollBetween() roll 1 1}}
            </td>
        </tr>
        {{#heat}}
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                Heat Check: {{heat}} vs {{heatroll}}
            </td>
        </tr>
        {{/heat}}
    </table>
    {{#mech}}
    <div class="sheet-rolltemplate-button-row">

        <div class="sheet-rolltemplate-button">
            [Push](~{{name}}|reactPush)
        </div>

        {{#^rollGreater() heatroll heat}}
        <div class="sheet-rolltemplate-button">
            [Reactor Overload](~{{name}}|reactOverload)
        </div>
        {{/^rollGreater() heatroll heat}}
    </div>
    {{/mech}}
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-overload">
    <table>
        <tr>
            <th>
                {{name}} rolls
            </th>
        </tr>
        <tr>
            <td>
                <div class="sheet-rolltemplate-spacer"></div>
            </td>
        </tr>
        <tr>
            <td>
                {{#rollBetween() roll 20 20}}
                <strong>Reactor Overdrive</strong> ({{roll}}) <br>
                Your Mech’s reactor goes into overdrive. Your Mech can take any additional action this turn or Push their next roll within 10 minutes for free.
                {{/rollBetween() roll 20 20}}

                {{#rollBetween() roll 11 19}}
                Reactor Overheat ({{roll}}) - Your Mech’s reactor has overheated. Your Mech shuts down and gains the Vulnerable Trait. Your Mech will re-activate at the end of your next turn. In addition, your Mech takes {{heat}} of SP damage.
                {{/rollBetween() roll 11 19}}

                {{#rollBetween() roll 6 10}}
                Module Overload ({{roll}}) - One of your Mech’s Modules chosen at random or by the Mediator is destroyed.
                {{/rollBetween() roll 6 10}}

                {{#rollBetween() roll 2 5}}
                System Overload ({{roll}}) - One of your Mech’s Systems chosen at random or by the Mediator is destroyed.
                {{/rollBetween() roll 2 5}}

                {{#rollBetween() roll 1 1}}
                Reactor Overload ({{roll}}) - Your Mech’s reactor goes into full meltdown and explodes. Your Mech, as well as any mounted Systems, Modules, and all Cargo, is destroyed in the explosion. Everything in Close Range of your Mech takes {{maxheat}} SP damage. They may take any Turn Action or Reaction in response to try to avoid this. Your Pilot dies unless they have a means to escape. The area your Mech was in becomes irradiated.
                {{/rollBetween() roll 1 1}}
            </td>
        </tr>
    </table>
</rolltemplate>